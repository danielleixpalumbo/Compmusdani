---
title: "How does today's Hip Hop differ from 90's Hip Hop?"
author: "Daniel Leix Palumbo"
date: "22 February 2019"
output: 
   flexdashboard::flex_dashboard:
       storyboard: true
       theme: lumen
       vertical_layout: scroll 
---

```{r, cache = FALSE}

devtools::install_github('charlie86/spotifyr')
devtools::install_github('jaburgoyne/compmus')

library(tidyverse)
library(spotifyr)
library(plotly)
library(compmus)

# Spotify access variables 

Sys.setenv(SPOTIFY_CLIENT_ID = '8e7bf977224b414d8e6b255352c63b5a')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '1b2f3f287a724da8b6ed562dbf4d99e1')

access_token <- get_spotify_access_token()
```

### Introduction 

![](http://townsquare.media/site/812/files/2018/01/xxx-tentacion-tupac.jpg)

*** 

How does hip-hop from the 1990s differ from hip-hop today? 

With the aim to answer to this question, It has been decided to look for reliable playlists on Spotify through which it could have been gained valuable insight into the most remarkable differences within and between the two time periods. In order to do so, two playlists have been chosen as corpus of data, namely "Hip Hop 90s" from "Hip Hop Heroes" and "Hip Hop 2019: Top100 Rap HITS 2019 / Rap 2019 New Hip Hop Songs" from "Filtr Espana", and have been analysed by comparing their key features. The two playlists contain respectively 64 and 100 tracks. 
These two playlists were chosen since they presented similar features in terms of number of followers and number of tracks, and also they contained tracks from the most famous and representative artists of the two time periods. 

### A closer look at the two playlists: is Hip Hop become faster in 20 years?  

```{r}

HipHop_90s <- get_playlist_audio_features('hhheroes', '5fWeZI5FLdUkowl4qaglPi')
HipHop_today <- get_playlist_audio_features('mejoresplaylistsspotify','0OtdLZ5JVyqB4Zp8aylECe')

HipHops <-
  HipHop_90s %>% mutate(playlist = "HipHop90") %>%
  bind_rows(HipHop_today %>% mutate(playlist = "HipHopToday"))

# Make our own visualisation 
HipHop_label_Around<- tibble(
    label = "Around the Way Girl",
    playlist = "HipHop90",
    speechiness = 0.356, 
    tempo = 202.084)
HipHop_label_Party<- tibble(
    label =  "Party Up",
    playlist = "HipHop90",
    speechiness = 0.347,
    tempo =  201.936)
HipHopScatterplot <-    
HipHops %>%
  ggplot(aes(x = speechiness, y = tempo, color = mode, size = energy, label = track_name)) +
   geom_point(alpha = 0.8)+
   facet_wrap(~ playlist)+
   geom_text (aes( x = speechiness,y = tempo, label = label), colour = "black", size = 3, data = HipHop_label_Around, hjust = "left", vjust = "up", nudge_y = 13)+
   geom_text (aes( x = speechiness,y = tempo, label = label), colour = "black", size = 3, data = HipHop_label_Party, hjust = "left", vjust = "bottom", nudge_y = 20)+
   geom_jitter(width = 0.00001, height = 0.00001)+
   theme_light() +              
   labs( x = "Speechines", y = "Tempo", colour = "Mode")+
   scale_y_continuous(limits = c(0, 240), breaks = c(0, 50, 100, 150, 200), minor_breaks = NULL)+
  scale_x_continuous(limits = c(0, 0.5), breaks = c(0, 0.1,  0.2,  0.3,  0.4,  0.5), minor_breaks = NULL)+
  scale_size_continuous(trans = "exp", guide = "none")
ggplotly(HipHopScatterplot)

```

*** 

After that the audio features from both playlists have been gathered using "spotifyr", it has been decided to represent the two data sets in two different scatterplots with speechiness on the x-axis and tempo on the y-axis. As a result, it can be observed on the scatterplots that overall Hip-Hop got significantly faster in 20 years, since most of the 90's tracks are below the 100 BPM level while most of the today's tracks cover the range from 100 BPM to 175. In addition, from the scatterplot can be observed also a couple of outliers, which are two today's hip hop songs, namely "Around the Way Girl" and "Party Up", that surprisingly are above the 200 BPM, representing the fastest tracks of both data sets. However, after I listened to both the songs, it must be said that in this case Spotify's tempo detection was far from the truth. 

The values of speechiness are slightly higher for the 90's tracks, demonstrating a little decrease of the use of spoken words in today's tracks. But here too, there's an outlier represented by today's track "Endless Summer Freestyle", which has the highest amount of spoken words with the value of 0.4630. In addition, the average danceability and energy for both playlists have been obtained but those haven't shown any remarkable difference for these features, the values of which are marginally higher in 90's tracks. However, the energy of the tracks has been mapped to the size of the dots, in order to make more information visible. 

Finally, as it can be observed in the scatterplot the dots are coloured by "mode", but in both playlist it has been found a certain balance between songs in major and in minor and there's no remarkable trend to be noticed. The increasing acceleration of today's Hip Hop tracks appear to be at the moment the most interesting finding.

### The use of samples in 90's Hip-Hop, a closer look to "He got game"

```{r}
HeGotGame <- 
    get_tidy_audio_analysis('7aRGb3vZGMLNpK2PEdUjdA') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
ForWhat <- 
    get_tidy_audio_analysis('1qRA5BS78u3gME0loMl9AA') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
TodayHipHop_dist <- 
    compmus_long_distance(
    HeGotGame %>% mutate(pitches = map(pitches, compmus_normalise, 'manhattan')),
    ForWhat %>% mutate(pitches = map(pitches, compmus_normalise, 'manhattan')),
    feature = pitches,
    method = 'aitchison')
```


```{r}
TodayHipHop <- 
   TodayHipHop_dist %>% 
    mutate(
        HeGotGame = xstart + xduration / 2, 
        ForWhat = ystart + yduration / 2) %>% 
    ggplot(
        aes(
            x = HeGotGame,
            y = ForWhat,
            fill = d)) + 
    geom_tile(aes(width = xduration, height = yduration)) +
    coord_fixed() +
    scale_x_continuous(
        breaks = c(0, 59, 79, 128, 148, 158, 197, 217, 286), 
        labels = 
            c(
                'Verse',
                'Chorus',
                'Verse2',
                'Chorus2',
                'Bridge',
                'OriginalTrackChorus',
                'Special',
                'FinalVerse',
                ''),
        ) +
    scale_y_continuous(
        breaks = c(0, 28, 34, 63, 69, 78, 97, 102, 112, 131, 153), 
        labels = 
            c(
                'Verse',
                'Chorus',
                'Verse2',
                'Chorus2',
                'Bridge',
                'Verse3',
                'Chorus3',
                'Bridge2' ,
                'Special' ,
                'Chorus4' , 
              ''),
        ) +
    scale_fill_viridis_c(option = 'E', guide = "none") +
    theme_classic() + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
    labs(x = 'He Got Game', y = 'For What it s Worth')
TodayHipHop
```

***

Finally, it has been decided to analyse through a chromagram the different key moment by pitch of one of the outlier present in the corpus, namely "Endless Summer Freestyle" by G-Eazy ft. YG. As it can be noticed in the chromagram, during the first 13 seconds of intro, in which only the backing track is playing (that is a sample of the song ""Neki-Hokey" by The Cleftones), there's really low energy distributed across the different pitch bands, probably also because of the "artistic" use of a filter for attenuating some frequency ranges. After the intro, voice and drums start to play and the distribution of energy is then equally distributed between C and C ♯ across all the track without any remarkable variation, maintaining a magnitude which may vary from 0,2 to 0,6. In fact, even if the track in question is from the today's corpus, its structure is pretty monotonous and without any chorus or change, reflecting rather the features of a more classical 90's Hip Hop song. 
Another remarkable feature to be noticed is the bass playing each fourth measure of the track, reflected by the regular peaks of magnitude ( about 0,5) on the A pitch band in the chromagram. 
Lastly, there's almost no energy distributed during the break from 165 (s) and 172 (s) and the end of the track, starting from 316 (s) where there's only voice.  

```{r}
TodayHipHop_hist <- 
    TodayHipHop_dist %>% 
    ggplot(aes(x = d)) +
    geom_histogram(binwidth = 0.5) +
    theme_classic() + 
    theme(
        axis.line.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
    scale_x_continuous(breaks = c(0.7, 4.4, 5.5, 6.8, 14.2)) +
    labs(x = 'Aitchison Distance', y = '')
ggsave("compmus-HeGotGame.png", TodayHipHop_hist, width = 3, height = 2, dpi = 'screen')
```

![](compmus-HeGotGame.png)

### How is changed the use of samples in today's Hip-Hop? Let's take "Endless Summer Freestyle" as benchmark for our comparison

```{r}
Endless <- 
    get_tidy_audio_analysis('6yxYCurtUz8MOAgWGxlAzP') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
Neky_Hokey <- 
    get_tidy_audio_analysis('0DelTitHNIJ8uUBpGpT0Hk') %>% 
    select(segments) %>% unnest(segments) %>% 
    select(start, duration, pitches)
OldHipHop_dist <- 
    compmus_long_distance(
    Endless %>% mutate(pitches = map(pitches, compmus_normalise, 'manhattan')),
    Neky_Hokey %>% mutate(pitches = map(pitches, compmus_normalise, 'manhattan')),
    feature = pitches,
    method = 'aitchison')
```


```{r}
OldHipHop <- 
    OldHipHop_dist %>% 
    mutate(
        Endless = xstart + xduration / 2, 
        Neky_Hokey = ystart + yduration / 2) %>% 
    ggplot(
        aes(
            x = Endless,
            y = Neky_Hokey,
            fill = d)) + 
    geom_tile(aes(width = xduration, height = yduration)) +
    coord_fixed() +
    scale_x_continuous(
        breaks = c(0, 14, 215, 237), 
        labels = 
            c(
                'Intro',
                'Verse',
                'Outro',
                ''),
        ) +
    scale_y_continuous(
        breaks = c(0, 7,  40, 56, 92, 103, 125, 141), 
        labels = 
            c(
                'Intro',
                'Chorus',
                'Verse',
                'Solo',
                'Verse2',
                'Chorus2',
                'Outro',
              ''),
        ) +
    scale_fill_viridis_c(option = 'E', guide = "none") +
    theme_classic() + 
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
    labs(x = 'Endless Summer Freestyle', y = 'Neky Hokey')
OldHipHop
```

***

Finally, it has been decided to analyse through a chromagram the different key moment by pitch of one of the outlier present in the corpus, namely "Endless Summer Freestyle" by G-Eazy ft. YG. As it can be noticed in the chromagram, during the first 13 seconds of intro, in which only the backing track is playing (that is a sample of the song ""Neki-Hokey" by The Cleftones), there's really low energy distributed across the different pitch bands, probably also because of the "artistic" use of a filter for attenuating some frequency ranges. After the intro, voice and drums start to play and the distribution of energy is then equally distributed between C and C ♯ across all the track without any remarkable variation, maintaining a magnitude which may vary from 0,2 to 0,6. In fact, even if the track in question is from the today's corpus, its structure is pretty monotonous and without any chorus or change, reflecting rather the features of a more classical 90's Hip Hop song. 
Another remarkable feature to be noticed is the bass playing each fourth measure of the track, reflected by the regular peaks of magnitude ( about 0,5) on the A pitch band in the chromagram. 
Lastly, there's almost no energy distributed during the break from 165 (s) and 172 (s) and the end of the track, starting from 316 (s) where there's only voice.  

```{r}
OldHipHop_hist <- 
    OldHipHop_dist %>% 
    ggplot(aes(x = d)) +
    geom_histogram(binwidth = 0.5) +
    theme_classic() + 
    theme(
        axis.line.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank()) +
    scale_x_continuous(breaks = c(0.7, 4.4, 5.5, 6.8, 14.2)) +
    labs(x = 'Aitchison Distance', y = '')
ggsave("compmus-Endless.png", OldHipHop_hist, width = 3, height = 2, dpi = 'screen')
```

![](compmus-Endless.png)


### Understanding of the structure of "The choise is yours" through an analysis of chroma and timbre features

```{r}
BlackSheep <- 
    get_tidy_audio_analysis('0cbodmgjBx4IVPOIyl3F4b') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'rms'))
BlackSheepplot <- 
    bind_rows(
        BlackSheep %>% compmus_self_similarity(pitches, 'angular') %>% mutate(d = d / max(d), type = "Chroma"),
        BlackSheep %>% compmus_self_similarity(timbre, 'cosine') %>% mutate(d = d / max(d), type = "Timbre")) %>% 
    ggplot(
        aes(
            x = xstart + xduration / 5, 
            width = xduration,
            y = ystart + yduration / 5,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    facet_wrap(~ type) +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
ggplotly(BlackSheepplot)
```

***

In this 4th section of the project the structure of the 90s Hip Hop true classic "The Choise is yours" by Black Sheep is analysed by comparing the chroma-based and timbre-based self-similarity matrices. 
As Hip Hop tracks tend to be pretty homogeneous in their structure, also "The Choise is yours" follows the same trend, by fundamentally showing two main sections in its structural layout, which could be named in this case as kind of verse and chorus. The alternation of the two sections is not well visible in the chroma-based matrix, as there are no great variations in terms of pitches across the entire song. 
In contrast, the timbre-based matrix makes this alternation much more visible, as the switch to the different part of the song is highlighted by the presence or the absence of certain instruments: the verse is charachterised by the well-known double bass riff, while in the chorus only voices and drums are present.

### Chordogram of the true classic "Changes" by 2pac

```{r}
circshift <- function(v, n) {if (n == 0) v else c(tail(v, n), head(v, -n))}
                                    
    # C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B 
major_chord <- 
    c(1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <- 
    c(1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <- 
    c(1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <- 
    c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
    c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
    tribble(
        ~name  , ~template,
        'Gb:7'  , circshift(seventh_chord,  6),
        'Gb:maj', circshift(major_chord,    6),
        'Bb:min', circshift(minor_chord,   10),
        'Db:maj', circshift(major_chord,    1),
        'F:min' , circshift(minor_chord,    5),
        'Ab:7'  , circshift(seventh_chord,  8),
        'Ab:maj', circshift(major_chord,    8),
        'C:min' , circshift(minor_chord,    0),
        'Eb:7'  , circshift(seventh_chord,  3),
        'Eb:maj', circshift(major_chord,    3),
        'G:min' , circshift(minor_chord,    7),
        'Bb:7'  , circshift(seventh_chord, 10),
        'Bb:maj', circshift(major_chord,   10),
        'D:min' , circshift(minor_chord,    2),
        'F:7'   , circshift(seventh_chord,  5),
        'F:maj' , circshift(major_chord,    5),
        'A:min' , circshift(minor_chord,    9),
        'C:7'   , circshift(seventh_chord,  0),
        'C:maj' , circshift(major_chord,    0),
        'E:min' , circshift(minor_chord,    4),
        'G:7'   , circshift(seventh_chord,  7),
        'G:maj' , circshift(major_chord,    7),
        'B:min' , circshift(minor_chord,   11),
        'D:7'   , circshift(seventh_chord,  2),
        'D:maj' , circshift(major_chord,    2),
        'F#:min', circshift(minor_chord,    6),
        'A:7'   , circshift(seventh_chord,  9),
        'A:maj' , circshift(major_chord,    9),
        'C#:min', circshift(minor_chord,    1),
        'E:7'   , circshift(seventh_chord,  4),
        'E:maj' , circshift(major_chord,    4),
        'G#:min', circshift(minor_chord,    8),
        'B:7'   , circshift(seventh_chord, 11),
        'B:maj' , circshift(major_chord,   11),
        'D#:min', circshift(minor_chord,    3),
)

key_templates <-
    tribble(
        ~name    , ~template,
        'Gb:maj', circshift(major_key,  6),
        'Bb:min', circshift(minor_key, 10),
        'Db:maj', circshift(major_key,  1),
        'F:min' , circshift(minor_key,  5),
        'Ab:maj', circshift(major_key,  8),
        'C:min' , circshift(minor_key,  0),
        'Eb:maj', circshift(major_key,  3),
        'G:min' , circshift(minor_key,  7),
        'Bb:maj', circshift(major_key, 10),
        'D:min' , circshift(minor_key,  2),
        'F:maj' , circshift(major_key,  5),
        'A:min' , circshift(minor_key,  9),
        'C:maj' , circshift(major_key,  0),
        'E:min' , circshift(minor_key,  4),
        'G:maj' , circshift(major_key,  7),
        'B:min' , circshift(minor_key, 11),
        'D:maj' , circshift(major_key,  2),
        'F#:min', circshift(minor_key,  6),
        'A:maj' , circshift(major_key,  9),
        'C#:min', circshift(minor_key,  1),
        'E:maj' , circshift(major_key,  4),
        'G#:min', circshift(minor_key,  8),
        'B:maj' , circshift(major_key, 11),
        'D#:min', circshift(minor_key,  3))
```

```{r}
Tupac <- 
    get_tidy_audio_analysis('3Wyc7M8twhxeyaC51BcQYb') %>% 
    compmus_align(beats, segments) %>% 
    select(beats) %>% unnest(beats) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan'))
    
```

```{r}
Tupac %>% 
    compmus_match_pitch_template(chord_templates, 'euclidean', 'manhattan') %>% 
    ggplot(
        aes(x = start + duration / 2, width = duration, y = name, fill = d)) +
    geom_tile() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_minimal() +
    labs(x = 'Time (s)', y = '')
```